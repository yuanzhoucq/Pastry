<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Settings - Pastry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="/js/theme.js"></script>
</head>

<body>
    <div class="page">
        <header class="header-bar">
            <div class="container">
                <div class="page-title">
                    <h1><a href="/" class="header-home text-metallic">Pastry</a><span id="headerPath"
                            class="header-username"></span>
                    </h1>
                </div>
                <nav class="flex gap-sm items-center">
                    <a id="backToProfile">‚Üê Back</a>
                    <button id="themeToggle" class="theme-toggle" title="Toggle theme"></button>
                </nav>
            </div>
        </header>

        <main class="main-content">
            <div class="container" style="max-width: 600px;">
                <!-- Not Unlocked State -->
                <div id="lockedState" class="card text-center">
                    <div style="padding: var(--spacing-xl);">
                        <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üîí</div>
                        <h2 style="margin-bottom: var(--spacing-md);">Authentication Required</h2>
                        <p class="text-muted" style="margin-bottom: var(--spacing-lg);">Please unlock your profile to
                            access settings.</p>
                        <button class="btn btn-primary" onclick="openModal('unlockModal')">üîì Unlock</button>
                    </div>
                </div>

                <div id="settingsContent" class="hidden">
                    <div class="card">
                        <h2 style="margin-bottom: var(--spacing-lg);">Profile Settings</h2>

                        <form id="settingsForm">
                            <div class="form-group">
                                <label class="form-label">Display Name</label>
                                <input type="text" class="form-input" id="displayName"
                                    placeholder="Enter your display name" maxlength="50">
                                <p class="text-muted" style="margin-top: var(--spacing-xs); font-size: 0.85rem;">
                                    Your visible name. Can include spaces, Chinese characters, emoji, etc. Leave blank
                                    to use your username.
                                </p>
                            </div>

                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="allowAnonUpload" checked>
                                    <span>Allow public uploads</span>
                                </label>
                                <p class="text-muted" style="margin-top: var(--spacing-xs); font-size: 0.85rem;">
                                    When enabled, anyone visiting your page can create pastes without unlocking.
                                </p>
                            </div>

                            <div style="margin-top: var(--spacing-lg);">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </div>
                        </form>
                    </div>

                    <div class="card" style="margin-top: var(--spacing-md);">
                        <h2 style="margin-bottom: var(--spacing-md);">Account Info</h2>
                        <div class="form-group">
                            <label class="form-label">Username (URL)</label>
                            <p id="displayUsername" style="font-weight: 500;"></p>
                            <p class="text-muted" style="margin-top: var(--spacing-xs); font-size: 0.85rem;">
                                Your URL path cannot be changed.
                            </p>
                        </div>
                        <div class="form-group" id="defaultPasswordSection">
                            <label class="form-label">Default Password</label>
                            <div class="code-block" id="displayDefaultPassword" style="font-size: 1rem;"></div>
                            <p class="text-muted" style="margin-top: var(--spacing-xs); font-size: 0.85rem;">
                                This is your current password for unlocking your profile.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Unlock Modal -->
    <div class="modal-overlay" id="unlockModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üîì Unlock Profile</h3>
                <button class="modal-close" onclick="closeModal('unlockModal')">&times;</button>
            </div>
            <form id="unlockForm">
                <div id="unlockAlert"></div>
                <div class="form-group">
                    <label class="form-label">Your Password</label>
                    <input type="password" class="form-input" id="unlockPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Unlock</button>
            </form>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        // Extract username from URL: /:username/setting
        const pathParts = window.location.pathname.split('/');
        const pageUsername = pathParts[1];

        // Update page elements
        document.getElementById('pageTitle').textContent = `Settings - ${pageUsername} - Pastry`;
        document.getElementById('headerPath').textContent = `/ ${pageUsername} / setting`;
        document.getElementById('backToProfile').href = `/${pageUsername}`;
        document.getElementById('displayUsername').textContent = pageUsername;

        let isUnlocked = false;
        let currentDisplayName = '';

        // Check if already has a valid token
        async function checkAuth() {
            if (!API.userToken) return;

            try {
                // Try to load settings to verify token is valid
                const data = await API.getUserPage(pageUsername);
                // Token seems valid, unlock the UI
                unlockUI(data.allowAnonymousUpload, data.user.displayName);
            } catch (err) {
                // Token invalid, clear it
                API.clearUserToken();
            }
        }

        function unlockUI(allowAnonymousUpload, displayName = null, defaultPassword = null) {
            isUnlocked = true;
            document.getElementById('lockedState').classList.add('hidden');
            document.getElementById('settingsContent').classList.remove('hidden');
            document.getElementById('allowAnonUpload').checked = allowAnonymousUpload;

            // Set display name (empty if same as username to show placeholder)
            currentDisplayName = displayName === pageUsername ? '' : (displayName || '');
            document.getElementById('displayName').value = currentDisplayName;

            if (defaultPassword) {
                document.getElementById('displayDefaultPassword').textContent = defaultPassword;
            } else {
                document.getElementById('defaultPasswordSection').classList.add('hidden');
            }
        }

        // Unlock form
        document.getElementById('unlockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('unlockPassword').value;

            try {
                const result = await API.unlockUserPage(pageUsername, password);
                API.setUserToken(result.token);

                // Also fetch user data to get display name
                const userData = await API.getUserPage(pageUsername);

                unlockUI(
                    result.user.allow_anonymous_upload,
                    userData.user.displayName,
                    result.user.default_password
                );

                closeModal('unlockModal');
            } catch (err) {
                showAlert(document.getElementById('unlockAlert'), err.message);
            }
        });

        // Settings form
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const allowAnonUpload = document.getElementById('allowAnonUpload').checked;
            const displayName = document.getElementById('displayName').value.trim();

            try {
                await API.updateUserSettings(pageUsername, {
                    allow_anonymous_upload: allowAnonUpload,
                    display_name: displayName || null
                });
                showModal({ title: 'Success', message: 'Settings saved successfully!', type: 'success' });
            } catch (err) {
                showModal({ title: 'Error', message: 'Failed to save settings: ' + err.message, type: 'error' });
            }
        });

        // Initialize
        checkAuth();
    </script>
</body>

</html>