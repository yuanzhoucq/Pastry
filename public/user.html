<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">User - Pastry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="/js/icons.js"></script>
    <script src="/js/theme.js"></script>
</head>

<body>
    <div class="page">
        <header class="header-bar">
            <div class="container">
                <div class="page-title">
                    <h1><a href="/" class="header-home text-metallic">Pastry</a><span id="username"
                            class="header-username"></span>
                    </h1>
                </div>
                <nav class="flex gap-sm items-center">
                    <a id="adminLink" href="/app/admin" class="hidden"> Admin Panel</a>
                    <div id="userMenu" class="dropdown hidden">
                        <span id="displayNameLabel" class="dropdown-trigger"></span>
                        <div class="dropdown-menu">
                            <a id="settingsLink" class="dropdown-item">Settings</a>
                            <button id="signOutBtn" class="dropdown-item">Sign Out</button>
                        </div>
                    </div>
                    <button id="unlockBtn">Sign In</button>
                    <button id="themeToggle" class="theme-toggle" title="Toggle theme"></button>
                </nav>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                <!-- Main Card with Two Column Layout -->
                <div class="card">
                    <div class="user-layout">
                        <!-- Left: Create Paste Section -->
                        <div id="createSection" class="hidden">
                            <h2 style="margin-bottom: var(--spacing-lg);">Create New Paste</h2>

                            <div class="tabs" style="border-bottom: none; margin-bottom: var(--spacing-md);">
                                <button class="tab active" data-type="text"><span class="tab-icon"></span> Text</button>
                                <button class="tab" data-type="file"><span class="tab-icon"></span> File</button>
                            </div>

                            <form id="createPasteForm">
                                <!-- Text Input -->
                                <div id="textInput" class="form-group">
                                    <textarea class="form-textarea" id="pasteContent"
                                        placeholder="Paste your content here..."></textarea>
                                </div>

                                <!-- File Input -->
                                <div id="fileInput" class="form-group hidden">
                                    <div class="file-upload" id="dropZone">
                                        <div class="file-upload-icon" id="uploadIcon"></div>
                                        <p class="file-upload-text">Drag & drop a file or click to browse</p>
                                        <input type="file" id="pasteFile">
                                    </div>
                                    <div id="selectedFile" class="hidden" style="margin-top: var(--spacing-md);"></div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Paste Name</label>
                                    <div class="form-radio-group">
                                        <label class="form-radio" id="nameFilenameOption" style="display: none;">
                                            <input type="radio" name="nameOption" value="filename">
                                            <span>Use Filename</span>
                                        </label>
                                        <label class="form-radio">
                                            <input type="radio" name="nameOption" value="random" checked>
                                            <span>Automatic</span>
                                        </label>
                                        <label class="form-radio">
                                            <input type="radio" name="nameOption" value="custom">
                                            <span>Custom</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group hidden" id="customNameGroup">
                                    <label class="form-label">Custom Name</label>
                                    <input type="text" class="form-input" id="pasteName" placeholder="Enter paste name">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Expiration</label>
                                    <div class="form-radio-group" id="expirationOptions">
                                        <label class="form-radio" data-days="0.0416667">
                                            <input type="radio" name="expirationOption" value="0.0416667" checked>
                                            <span>1 Hour</span>
                                        </label>
                                        <label class="form-radio" data-days="1">
                                            <input type="radio" name="expirationOption" value="1">
                                            <span>1 Day</span>
                                        </label>
                                        <label class="form-radio" data-days="7">
                                            <input type="radio" name="expirationOption" value="7">
                                            <span>7 Days</span>
                                        </label>
                                        <label class="form-radio" data-days="30">
                                            <input type="radio" name="expirationOption" value="30">
                                            <span>30 Days</span>
                                        </label>
                                        <label class="form-radio" data-days="365">
                                            <input type="radio" name="expirationOption" value="365">
                                            <span>1 Year</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Password Protection</label>
                                    <div class="form-radio-group">
                                        <label class="form-radio">
                                            <input type="radio" name="passwordOption" value="none" checked>
                                            <span>None (public)</span>
                                        </label>
                                        <label class="form-radio">
                                            <input type="radio" name="passwordOption" value="default">
                                            <span>Default</span>
                                        </label>
                                        <label class="form-radio">
                                            <input type="radio" name="passwordOption" value="random">
                                            <span>Random</span>
                                        </label>
                                        <label class="form-radio">
                                            <input type="radio" name="passwordOption" value="custom">
                                            <span>Custom</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group hidden" id="customPasswordGroup">
                                    <label class="form-label">Custom Password</label>
                                    <input type="text" class="form-input" id="customPassword"
                                        placeholder="Enter password">
                                </div>

                                <button type="submit" class="btn btn-primary">Create Paste</button>
                            </form>
                        </div>

                        <!-- Right: Paste List -->
                        <div id="pasteList">
                            <h2 style="margin-bottom: var(--spacing-md);">Pastes</h2>
                            <div id="pasteListContent" class="paste-list-simple">
                                <div class="empty-state">
                                    <div class="empty-state-icon" id="emptyIcon"></div>
                                    <p>Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Unlock Modal -->
    <div class="modal-overlay" id="unlockModal">
        <div class="modal">
            <div class="modal-header">
                <h3><span id="unlockModalIcon"></span> Unlock Homepage</h3>
                <button class="modal-close" onclick="closeModal('unlockModal')">&times;</button>
            </div>
            <form id="unlockForm">
                <div id="unlockAlert"></div>
                <div class="form-group">
                    <label class="form-label">Your Password</label>
                    <input type="password" class="form-input" id="unlockPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Unlock</button>
            </form>
        </div>
    </div>

    <!-- View Paste Modal -->
    <div class="modal-overlay" id="viewModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="viewPasteName">Paste</h3>
                <button class="modal-close" onclick="closeModal('viewModal')">&times;</button>
            </div>

            <!-- Password Form -->
            <div id="viewPasswordForm">
                <div id="viewAlert"></div>
                <div class="form-group">
                    <label class="form-label">Enter Password</label>
                    <input type="password" class="form-input" id="viewPassword">
                </div>
                <button class="btn btn-primary" onclick="verifyPastePassword()">Verify</button>
            </div>

            <!-- Content Display -->
            <div id="viewContent" class="hidden">
                <div id="textContent" class="code-block" style="max-height: 400px; overflow: auto;"></div>
                <div id="fileContent" class="hidden">
                    <p>Ready to download: <strong id="fileName"></strong></p>
                    <button class="btn btn-primary" id="downloadBtn" style="margin-top: var(--spacing-md);">Download
                        File</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generated Password Modal -->
    <div class="modal-overlay" id="generatedPasswordModal">
        <div class="modal">
            <div class="modal-header">
                <h3><span id="keyModalIcon"></span> Generated Password</h3>
                <button class="modal-close" onclick="closeModal('generatedPasswordModal')">&times;</button>
            </div>
            <p>Your paste was created with this password:</p>
            <div class="code-block" id="generatedPassword"
                style="margin-top: var(--spacing-md); font-size: 1.2rem; text-align: center;"></div>
            <p class="text-muted" style="margin-top: var(--spacing-md);"><span id="warningIcon"></span> Save this
                password - it won't be shown again!</p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3><span id="deleteModalIcon"></span> Delete Paste</h3>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <p>Are you sure you want to delete this paste? This action cannot be undone.</p>
            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                <button class="btn" style="flex: 1;" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="btn btn-danger" style="flex: 1;" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        const pageUsername = window.location.pathname.slice(1);
        let isUnlocked = false;
        let allowAnonymousUpload = true;
        let currentPasteId = null;
        let currentPasteType = null;
        let pasteType = 'text';

        // Initialize icons
        document.querySelectorAll('.tab-icon').forEach((el, i) => {
            el.innerHTML = i === 0 ? Icons.fileText('sm') : Icons.folder('sm');
        });
        document.getElementById('uploadIcon').innerHTML = Icons.upload('2xl');
        document.getElementById('emptyIcon').innerHTML = Icons.inbox('2xl');
        document.getElementById('unlockModalIcon').innerHTML = Icons.unlock('md');
        document.getElementById('keyModalIcon').innerHTML = Icons.key('md');
        document.getElementById('warningIcon').innerHTML = Icons.alertTriangle('sm');
        document.getElementById('deleteModalIcon').innerHTML = Icons.trash('md');

        // Initialize
        document.getElementById('username').textContent = `/ ${pageUsername}`;
        document.getElementById('pageTitle').textContent = `${pageUsername} - Pastry`;
        document.getElementById('settingsLink').href = `/${pageUsername}/setting`;

        // Show admin panel link if viewing admin user's page
        if (pageUsername === 'admin') {
            document.getElementById('adminLink').classList.remove('hidden');
        }

        // Tab switching for paste type
        document.querySelectorAll('.tabs .tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                pasteType = tab.dataset.type;

                document.getElementById('textInput').classList.toggle('hidden', pasteType !== 'text');
                document.getElementById('fileInput').classList.toggle('hidden', pasteType !== 'file');

                // Show/hide filename option based on paste type
                updateNameOptions();
            });
        });

        // Name option toggle
        document.querySelectorAll('input[name="nameOption"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('customNameGroup').classList.toggle('hidden', radio.value !== 'custom');
            });
        });

        // Password option toggle
        document.querySelectorAll('input[name="passwordOption"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('customPasswordGroup').classList.toggle('hidden', radio.value !== 'custom');
            });
        });

        // File drag and drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('pasteFile');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                updateFileDisplay();
            }
        });

        fileInput.addEventListener('change', updateFileDisplay);

        function updateFileDisplay() {
            const file = fileInput.files[0];
            const display = document.getElementById('selectedFile');
            if (file) {
                display.classList.remove('hidden');
                display.innerHTML = `
          <div class="alert alert-info">
            ${Icons.paperclip('sm')} ${file.name} (${formatSize(file.size)})
          </div>
        `;
                // Update name options when file is selected
                updateNameOptions();
            } else {
                display.classList.add('hidden');
                updateNameOptions();
            }
        }

        // Update name options based on paste type and file selection
        function updateNameOptions() {
            const filenameOption = document.getElementById('nameFilenameOption');
            const filenameRadio = filenameOption.querySelector('input');
            const hasFile = pasteType === 'file' && fileInput.files.length > 0;

            if (hasFile) {
                filenameOption.style.display = '';
                // Select filename option by default when file is selected
                filenameRadio.checked = true;
                document.getElementById('customNameGroup').classList.add('hidden');
            } else {
                filenameOption.style.display = 'none';
                // If filename was selected, switch to random
                if (filenameRadio.checked) {
                    document.querySelector('input[name="nameOption"][value="random"]').checked = true;
                }
            }
        }

        // Update expiration options based on admin max setting
        function updateExpirationOptions(maxDays) {
            const container = document.getElementById('expirationOptions');
            const options = container.querySelectorAll('.form-radio');

            let firstVisibleChecked = false;
            options.forEach(option => {
                const days = parseFloat(option.dataset.days);
                const radio = option.querySelector('input');

                if (days <= maxDays) {
                    option.style.display = '';
                    // Check first visible option if current selection is hidden
                    if (!firstVisibleChecked) {
                        const currentChecked = container.querySelector('input:checked');
                        if (!currentChecked || currentChecked.closest('.form-radio').style.display === 'none') {
                            radio.checked = true;
                        }
                        firstVisibleChecked = true;
                    }
                } else {
                    option.style.display = 'none';
                    radio.checked = false;
                }
            });
        }

        // Load pastes
        async function loadPastes() {
            try {
                const data = await API.getUserPage(pageUsername);
                const container = document.getElementById('pasteListContent');

                // Update display name in header and page title
                const displayName = data.user.displayName || pageUsername;
                // Header always shows URL username, page title shows display name
                document.getElementById('pageTitle').textContent = `${displayName} - Pastry`;

                // Update allowAnonymousUpload from server
                allowAnonymousUpload = data.allowAnonymousUpload;

                // Update expiration options based on max setting
                updateExpirationOptions(data.maxExpirationDays);

                // Show create section if allowed and not unlocked yet
                if (allowAnonymousUpload && !isUnlocked) {
                    document.getElementById('createSection').classList.remove('hidden');
                }

                if (data.pastes.length === 0) {
                    container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">${Icons.inbox('2xl')}</div>
              <p>No pastes yet</p>
            </div>
          `;
                    return;
                }

                container.innerHTML = data.pastes.map(paste => `
          <div class="paste-item" data-id="${paste.id}" onclick="viewPaste('${paste.id}', '${paste.type}', ${paste.has_password})">
            <div class="paste-info">
              <div class="paste-name">
                <span class="icon">${paste.type === 'text' ? Icons.fileText('sm') : Icons.folder('sm')}</span>
                ${paste.name}
                ${paste.has_password ? `<span class="badge">${Icons.lock('sm')}</span>` : ''}
              </div>
              <div class="paste-meta">
                <span>${formatDate(paste.created_at)}</span>
                <span>${paste.type === 'text' && paste.word_count !== undefined ? paste.word_count + ' words' : formatSize(paste.size)}</span>
                ${paste.expires_at ? `<span>Expires ${formatDate(paste.expires_at)}</span>` : ''}
              </div>
            </div>
            ${isUnlocked ? `
              <div class="paste-actions" onclick="event.stopPropagation()">
                <button class="btn btn-danger btn-sm" onclick="deletePaste('${paste.id}')">Delete</button>
              </div>
            ` : ''}
          </div>
        `).join('');
            } catch (err) {
                document.getElementById('pasteListContent').innerHTML = `
          <div class="alert alert-error">User not found</div>
        `;
            }
        }

        // Unlock homepage
        document.getElementById('unlockBtn').addEventListener('click', () => {
            openModal('unlockModal');
        });

        document.getElementById('unlockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('unlockPassword').value;

            try {
                const result = await API.unlockUserPage(pageUsername, password);
                API.setUserToken(result.token);
                isUnlocked = true;

                // Update allow_anonymous_upload from unlock response
                allowAnonymousUpload = result.user.allow_anonymous_upload;

                document.getElementById('unlockBtn').classList.add('hidden');
                document.getElementById('createSection').classList.remove('hidden');

                // Show display name in nav
                const userData = await API.getUserPage(pageUsername);
                const displayName = userData.user.displayName || pageUsername;
                document.getElementById('displayNameLabel').textContent = displayName;
                document.getElementById('userMenu').classList.remove('hidden');

                closeModal('unlockModal');
                loadPastes();
            } catch (err) {
                showAlert(document.getElementById('unlockAlert'), err.message);
            }
        });

        // Create paste
        document.getElementById('createPasteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();

            if (pasteType === 'text') {
                const content = document.getElementById('pasteContent').value;
                if (!content.trim()) {
                    showModal({ title: 'Validation Error', message: 'Please enter some content', type: 'error' });
                    return;
                }
                formData.append('content', content);
            } else {
                const file = document.getElementById('pasteFile').files[0];
                if (!file) {
                    showModal({ title: 'Validation Error', message: 'Please select a file', type: 'error' });
                    return;
                }
                formData.append('file', file);
            }

            // Handle name option
            const nameOption = document.querySelector('input[name="nameOption"]:checked').value;
            if (nameOption === 'custom') {
                const customName = document.getElementById('pasteName').value.trim();
                if (customName) formData.append('name', customName);
            } else if (nameOption === 'filename' && pasteType === 'file') {
                const file = document.getElementById('pasteFile').files[0];
                if (file) {
                    // Remove extension for the paste name
                    const fileName = file.name.replace(/\.[^/.]+$/, '');
                    formData.append('name', fileName);
                }
            }
            // For 'random', don't send name - server will generate

            const expirationRadio = document.querySelector('input[name="expirationOption"]:checked');
            const expires = expirationRadio ? expirationRadio.value : '0.0416667';
            if (parseFloat(expires) > 0) {
                formData.append('expiresIn', expires);
            }

            const passwordOption = document.querySelector('input[name="passwordOption"]:checked').value;
            formData.append('passwordOption', passwordOption);

            if (passwordOption === 'custom') {
                formData.append('customPassword', document.getElementById('customPassword').value);
            }

            try {
                const result = await API.createPaste(formData);

                // Show generated password if applicable
                if (result.generatedPassword) {
                    document.getElementById('generatedPassword').textContent = result.generatedPassword;
                    openModal('generatedPasswordModal');
                }

                // Reset form
                document.getElementById('createPasteForm').reset();
                document.getElementById('selectedFile').classList.add('hidden');
                document.getElementById('customNameGroup').classList.add('hidden');
                document.getElementById('customPasswordGroup').classList.add('hidden');
                updateNameOptions();

                loadPastes();
            } catch (err) {
                showModal({ title: 'Error', message: 'Failed to create paste: ' + err.message, type: 'error' });
            }
        });

        // View paste
        function viewPaste(id, type, hasPassword) {
            currentPasteId = id;
            currentPasteType = type;

            document.getElementById('viewPasteName').textContent = 'View Paste';
            document.getElementById('viewPasswordForm').classList.toggle('hidden', !hasPassword);
            document.getElementById('viewContent').classList.toggle('hidden', hasPassword);
            document.getElementById('viewPassword').value = '';
            document.getElementById('viewAlert').innerHTML = '';

            if (!hasPassword) {
                // Load content directly
                loadPasteContent(id);
            }

            openModal('viewModal');
        }

        async function verifyPastePassword() {
            const password = document.getElementById('viewPassword').value;

            try {
                const result = await API.verifyPaste(currentPasteId, password);

                document.getElementById('viewPasswordForm').classList.add('hidden');
                document.getElementById('viewContent').classList.remove('hidden');

                displayPasteContent(result);
            } catch (err) {
                showAlert(document.getElementById('viewAlert'), err.message);
            }
        }

        async function loadPasteContent(id) {
            try {
                const result = await API.verifyPaste(id, '');
                displayPasteContent(result);
            } catch (err) {
                // Needs password after all
                document.getElementById('viewPasswordForm').classList.remove('hidden');
                document.getElementById('viewContent').classList.add('hidden');
            }
        }

        function displayPasteContent(result) {
            const textContent = document.getElementById('textContent');
            const fileContent = document.getElementById('fileContent');

            if (result.content !== undefined) {
                textContent.textContent = result.content;
                textContent.classList.remove('hidden');
                fileContent.classList.add('hidden');
            } else if (result.download) {
                textContent.classList.add('hidden');
                fileContent.classList.remove('hidden');
                document.getElementById('fileName').textContent = result.filename;
                document.getElementById('downloadBtn').onclick = () => {
                    window.location.href = `/api/pastes/${currentPasteId}/download?token=${currentPasteId}`;
                };
            }
        }

        // Delete paste
        let pendingDeleteId = null;

        function deletePaste(id) {
            pendingDeleteId = id;
            openModal('deleteModal');
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!pendingDeleteId) return;

            try {
                await API.deletePaste(pendingDeleteId);
                closeModal('deleteModal');
                loadPastes();
            } catch (err) {
                closeModal('deleteModal');
                showModal({ title: 'Error', message: 'Failed to delete: ' + err.message, type: 'error' });
            } finally {
                pendingDeleteId = null;
            }
        });

        // Initialize
        loadPastes();

        // Check if we have a valid user token and restore session
        async function checkSession() {
            if (!API.userToken) return;

            try {
                // Try to update settings with no changes - this verifies token AND user ownership
                await API.updateUserSettings(pageUsername, {});

                // Token is valid and belongs to this user - restore unlocked UI state
                const userData = await API.getUserPage(pageUsername);
                isUnlocked = true;
                allowAnonymousUpload = userData.allowAnonymousUpload;

                document.getElementById('unlockBtn').classList.add('hidden');
                document.getElementById('createSection').classList.remove('hidden');

                // Show display name in nav
                const displayName = userData.user.displayName || pageUsername;
                document.getElementById('displayNameLabel').textContent = displayName;
                document.getElementById('userMenu').classList.remove('hidden');

                loadPastes();
            } catch (err) {
                // Token invalid or doesn't belong to this user, clear it
                API.clearUserToken();
            }
        }

        checkSession();

        // User menu dropdown
        const userMenu = document.getElementById('userMenu');
        const displayNameLabel = document.getElementById('displayNameLabel');

        displayNameLabel.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenu.classList.toggle('open');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            userMenu.classList.remove('open');
        });

        // Sign out
        document.getElementById('signOutBtn').addEventListener('click', () => {
            API.clearUserToken();
            window.location.reload();
        });
    </script>
</body>

</html>